<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²ä½œæ¥­è¨˜éŒ²ç°¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="config.js"></script>
    <style>
        /* ============================================
           ãƒªã‚»ãƒƒãƒˆ & ãƒ™ãƒ¼ã‚¹
           ============================================ */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Segoe UI", "Hiragino Sans", "Noto Sans JP", "Meiryo", sans-serif;
            background: #f7f9f7;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ============================================
           ãƒ˜ãƒƒãƒ€ãƒ¼
           ============================================ */
        .app-header {
            background: linear-gradient(135deg, #2e7d32, #4CAF50);
            color: #fff;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header h1 {
            font-size: 1.3em;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        .app-header .subtitle {
            font-size: 0.8em;
            opacity: 0.85;
            margin-top: 2px;
        }

        /* ============================================
           ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
           ============================================ */
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* ============================================
           ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼
           ============================================ */
        .filter-bar {
            background: #fff;
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .filter-bar label {
            font-size: 0.9em;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9em;
            background: #fff;
            color: #333;
            min-width: 160px;
            cursor: pointer;
        }
        .filter-bar select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76,175,80,0.2);
        }
        .result-count {
            font-size: 0.85em;
            color: #888;
            margin-left: auto;
        }

        /* ============================================
           ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
           ============================================ */
        .badge {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 12px;
            font-size: 0.82em;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-active  { background: #e8f5e9; color: #2e7d32; }
        .badge-plan    { background: #fff3e0; color: #e65100; }
        .badge-done    { background: #e3f2fd; color: #1565c0; }

        /* ============================================
           ã‚µã‚¤ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰
           ============================================ */
        .cycle-card {
            background: #fff;
            border-radius: 10px;
            padding: 16px 18px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            margin-bottom: 12px;
            cursor: pointer;
            transition: box-shadow 0.15s ease, border-color 0.15s ease;
        }
        .cycle-card:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-color: #b0d4b0;
        }
        .cycle-card.expanded {
            border-color: #4CAF50;
            box-shadow: 0 3px 12px rgba(76,175,80,0.15);
        }
        .cycle-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .cycle-card-header h3 {
            color: #2e7d32;
            font-size: 1.05em;
            margin: 0;
        }
        .cycle-meta {
            font-size: 0.85em;
            color: #777;
            margin-top: 6px;
        }
        .cycle-detail {
            display: none;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #eee;
        }
        .cycle-card.expanded .cycle-detail {
            display: block;
        }
        .cycle-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px 16px;
            margin-bottom: 14px;
        }
        .cycle-info-item {
            font-size: 0.88em;
        }
        .cycle-info-item .label {
            color: #888;
            font-weight: 600;
        }

        /* ============================================
           ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
           ============================================ */
        .timeline-section h4 {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 12px;
        }
        .tl-container {
            position: relative;
            padding: 10px 0 10px 40px;
        }
        .tl-container::before {
            content: '';
            position: absolute;
            left: 18px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #4CAF50, #81C784);
            border-radius: 2px;
        }
        .tl-item {
            position: relative;
            margin-bottom: 14px;
            padding: 12px 16px;
            background: #fafffe;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .tl-item::before {
            content: '';
            position: absolute;
            left: -31px;
            top: 16px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: #4CAF50;
            border: 3px solid #e8f5e9;
        }
        .tl-date {
            font-size: 0.82em;
            color: #888;
            font-weight: 600;
            margin-bottom: 3px;
        }
        .tl-type {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            background: #e8f5e9;
            color: #2e7d32;
            font-size: 0.82em;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .tl-content {
            font-size: 0.92em;
            color: #333;
            line-height: 1.5;
        }
        .tl-note {
            font-size: 0.82em;
            color: #999;
            margin-top: 3px;
        }
        .tl-extra {
            font-size: 0.82em;
            color: #777;
            margin-top: 2px;
        }

        /* ============================================
           ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
           ============================================ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .loading .spinner {
            display: inline-block;
            width: 36px;
            height: 36px;
            border: 4px solid #e0e0e0;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           ã‚¨ãƒ©ãƒ¼ / ç©º
           ============================================ */
        .message-box {
            text-align: center;
            padding: 40px 20px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            color: #888;
            font-size: 0.95em;
        }
        .message-box.error {
            color: #c62828;
            border-color: #ffcdd2;
            background: #ffebee;
        }

        /* ============================================
           ãƒ•ãƒƒã‚¿ãƒ¼
           ============================================ */
        .app-footer {
            text-align: center;
            padding: 24px 16px;
            font-size: 0.8em;
            color: #aaa;
        }

        /* ============================================
           å±•é–‹ã‚¢ã‚¤ã‚³ãƒ³
           ============================================ */
        .expand-icon {
            margin-left: auto;
            font-size: 0.85em;
            color: #aaa;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        .cycle-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* ============================================
           ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–
           ============================================ */
        @media (max-width: 600px) {
            .container { padding: 12px 10px; }
            .app-header { padding: 12px 16px; }
            .app-header h1 { font-size: 1.1em; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-bar select { min-width: 100%; }
            .result-count { margin-left: 0; }
            .cycle-card { padding: 12px 14px; }
            .cycle-info-grid { grid-template-columns: 1fr; }
            .tl-container { padding-left: 32px; }
            .tl-item::before { left: -25px; width: 11px; height: 11px; }
            .tl-container::before { left: 14px; }
        }
    </style>
</head>
<body>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header" style="display:flex;align-items:center;justify-content:space-between;">
        <div>
            <h1 id="appTitle">ğŸŒ¾ è¾²ä½œæ¥­è¨˜éŒ²ç°¿</h1>
            <div class="subtitle">ä½œä»˜ã‘ä¸€è¦§ï¼ˆç°¡æ˜“ï¼‰</div>
        </div>
        <a href="https://script.google.com/macros/s/AKfycbw09_HKsqED2fEAkJskeYbT-QqUymhkOjiVf8VGoEkzBf23a8DbnurK1buHNh-CKexj/exec"
           target="_blank"
           style="background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:6px 16px;border-radius:6px;font-size:0.82em;text-decoration:none;"
           >ç®¡ç†ç”»é¢</a>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="container">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="filter-bar" id="filterBar" style="display:none;">
            <label for="statusFilter">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="statusFilter">
                <option value="ã™ã¹ã¦">ã™ã¹ã¦</option>
                <option value="è‚²è‹—ä¸­">è‚²è‹—ä¸­</option>
                <option value="ã¾ã‚‚ãªãåç©«é–‹å§‹">ã¾ã‚‚ãªãåç©«é–‹å§‹</option>
                <option value="åç©«ä¸­">åç©«ä¸­</option>
                <option value="ã¾ã‚‚ãªãåç©«çµ‚äº†">ã¾ã‚‚ãªãåç©«çµ‚äº†</option>
                <option value="çµ‚äº†">çµ‚äº†</option>
                <option value="è¨ˆç”»ä¸­">è¨ˆç”»ä¸­</option>
            </select>
            <span class="result-count" id="resultCount"></span>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
        <div id="cycleList">
            <div class="loading">
                <div class="spinner"></div>
                <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</div>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="app-footer">
        è¾²ä½œæ¥­è¨˜éŒ²ç°¿ v2.0 â”€ Google Sheets é€£æºç‰ˆ
    </footer>

    <script>
    /* ============================================================
       ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿
       ============================================================ */
    let cropCycles = [];
    let workLogs = [];
    let expandedCycleId = null;

    /* ============================================================
       Google Sheets ã‹ã‚‰CSVã‚’å–å¾—
       ============================================================ */
    function buildSheetURL(sheetName) {
        if (CONFIG.PUBLISHED_ID) {
            return `https://docs.google.com/spreadsheets/d/e/${CONFIG.PUBLISHED_ID}/pub?output=csv&sheet=${encodeURIComponent(sheetName)}`;
        }
        return `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    }

    async function fetchSheetCSV(sheetName) {
        const url = buildSheetURL(sheetName);

        const response = await fetch(url, { redirect: "follow" });
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const csvText = await response.text();

        if (csvText.trim().startsWith("<!") || csvText.trim().startsWith("<html")) {
            throw new Error("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚å…¬é–‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }

        const results = Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
        });

        if (results.errors && results.errors.length > 0) {
            console.warn("CSV ãƒ‘ãƒ¼ã‚¹è­¦å‘Š:", results.errors);
        }

        return results.data;
    }

    /* ============================================================
       ãƒ‡ãƒ¼ã‚¿å–å¾— & åˆæœŸåŒ–
       ============================================================ */
    async function loadData() {
        try {
            if (!CONFIG.PUBLISHED_ID && (!CONFIG.SHEET_ID || CONFIG.SHEET_ID === "ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’è²¼ã‚Šä»˜ã‘")) {
                showError("config.js ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¬é–‹IDã¾ãŸã¯ã‚·ãƒ¼ãƒˆIDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>è©³ã—ãã¯ README.md ã‚’ã”è¦§ãã ã•ã„ã€‚");
                return;
            }

            const [cyclesRaw, logsRaw] = await Promise.all([
                fetchSheetCSV(CONFIG.CROP_CYCLES_SHEET),
                fetchSheetCSV(CONFIG.WORK_LOGS_SHEET),
            ]);

            cropCycles = parseCropCycles(cyclesRaw);
            workLogs = parseWorkLogs(logsRaw);

            document.getElementById("filterBar").style.display = "flex";
            render();
        } catch (err) {
            console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
            showError(
                "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>" +
                "ãƒ»ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒã€Œã‚¦ã‚§ãƒ–ã«å…¬é–‹ã€ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„<br>" +
                "ãƒ»config.js ã®å…¬é–‹IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„<br>" +
                "<small style='color:#999;margin-top:8px;display:block;'>ã‚¨ãƒ©ãƒ¼: " + (err.message || err) + "</small>"
            );
        }
    }

    /* ============================================================
       ãƒ‡ãƒ¼ã‚¿å¤‰æ›ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—å â†’ å†…éƒ¨ã‚­ãƒ¼ï¼‰
       ============================================================ */
    function parseCropCycles(rows) {
        return rows.map((r, idx) => ({
            id:             (r["ä½œä»˜ã‘ID"] || "").trim() || String(idx + 1),
            crop_name:      (r["ä½œç‰©å"] || "").trim(),
            variety:        (r["å“ç¨®"] || "").trim(),
            field_id:       (r["åœƒå ´ID"] || "").trim(),
            row_id:         (r["ç•ID"] || "").trim(),
            start_date:     (r["é–‹å§‹æ—¥"] || "").trim(),
            end_date:       (r["çµ‚äº†æ—¥"] || "").trim(),
            status:         (r["ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"] || "è¨ˆç”»ä¸­").trim(),
            yield_amount:   (r["åé‡"] || "").trim(),
            yield_unit:     (r["å˜ä½"] || "kg").trim(),
            quality_rating: (r["å“è³ªè©•ä¾¡"] || "").trim(),
            quality_note:   (r["å“è³ªãƒ¡ãƒ¢"] || "").trim(),
            comment:        (r["ã‚³ãƒ¡ãƒ³ãƒˆ"] || "").trim(),
        })).filter(c => c.crop_name);
    }

    function parseWorkLogs(rows) {
        return rows.map((r, idx) => ({
            id:        (r["è¨˜éŒ²ID"] || "").trim() || String(idx + 1),
            cycle_id:  (r["ä½œä»˜ã‘ID"] || "").trim(),
            work_date: (r["ä½œæ¥­æ—¥"] || "").trim(),
            work_type: (r["ä½œæ¥­ç¨®åˆ¥"] || "").trim(),
            cell_pot:  (r["ã‚»ãƒ«ãƒ»ãƒãƒƒãƒˆ"] || "").trim(),
            quantity:  (r["æ•°é‡"] || "").trim(),
            field_id:  (r["åœƒå ´ID"] || "").trim(),
            row_id:    (r["ç•ID"] || "").trim(),
            content:   (r["å†…å®¹"] || "").trim(),
            note:      (r["å‚™è€ƒ"] || "").trim(),
        })).filter(l => l.work_date || l.content);
    }

    /* ============================================================
       æç”»
       ============================================================ */
    function render() {
        const filter = document.getElementById("statusFilter").value;
        let filtered = cropCycles;
        if (filter !== "ã™ã¹ã¦") {
            filtered = cropCycles.filter(c => c.status === filter);
        }

        // é–‹å§‹æ—¥ã®é™é †ã§ã‚½ãƒ¼ãƒˆ
        filtered.sort((a, b) => {
            const da = a.start_date || "9999";
            const db = b.start_date || "9999";
            return db.localeCompare(da);
        });

        document.getElementById("resultCount").textContent = `${filtered.length} ä»¶ã®ä½œä»˜ã‘`;

        const container = document.getElementById("cycleList");
        if (filtered.length === 0) {
            container.innerHTML = '<div class="message-box">è©²å½“ã™ã‚‹ä½œä»˜ã‘ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        container.innerHTML = filtered.map(cy => buildCycleCard(cy)).join("");
    }

    function buildCycleCard(cy) {
        const varietyText = cy.variety ? `ï¼ˆ${cy.variety}ï¼‰` : "";
        const fieldInfo = cy.field_id ? `ğŸ“ ${cy.field_id}` : "ğŸ“ åœƒå ´æœªè¨­å®š";
        const period = `${cy.start_date || "?"} ï½ ${cy.end_date || "ç¶™ç¶šä¸­"}`;
        const isExpanded = expandedCycleId === cy.id;
        const expandedClass = isExpanded ? "expanded" : "";

        const logs = workLogs
            .filter(l => l.cycle_id === cy.id)
            .sort((a, b) => (a.work_date || "").localeCompare(b.work_date || ""));

        let detailHTML = buildDetailHTML(cy, logs);

        return `
            <div class="cycle-card ${expandedClass}" onclick="toggleCard('${escapeAttr(cy.id)}')">
                <div class="cycle-card-header">
                    <h3>ğŸŒ± ${esc(cy.crop_name)}${esc(varietyText)}</h3>
                    ${statusBadge(cy.status)}
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="cycle-meta">
                    ${esc(fieldInfo)}ã€€ï½œã€€${esc(period)}
                </div>
                <div class="cycle-detail">
                    ${detailHTML}
                </div>
            </div>
        `;
    }

    function buildDetailHTML(cy, logs) {
        let html = '<div class="cycle-info-grid">';
        html += infoItem("ä½œç‰©", cy.crop_name);
        html += infoItem("å“ç¨®", cy.variety || "â€•");
        html += infoItem("åœƒå ´", cy.field_id || "â€•");
        html += infoItem("ç•", cy.row_id || "â€•");

        if (cy.yield_amount) {
            html += infoItem("åé‡", `${cy.yield_amount} ${cy.yield_unit}`);
            html += infoItem("å“è³ªè©•ä¾¡", cy.quality_rating || "â€•");
        }
        html += '</div>';

        if (cy.quality_note) {
            html += `<div style="font-size:0.88em;color:#666;margin-bottom:10px;">å“è³ªãƒ¡ãƒ¢: ${esc(cy.quality_note)}</div>`;
        }
        if (cy.comment) {
            html += `<div style="font-size:0.88em;color:#666;margin-bottom:10px;">ğŸ’¬ ${esc(cy.comment)}</div>`;
        }

        if (logs.length > 0) {
            html += `<div class="timeline-section">`;
            html += `<h4>ğŸ“‹ ä½œæ¥­è¨˜éŒ²: ${logs.length} ä»¶</h4>`;
            html += buildTimeline(logs);
            html += `</div>`;
        } else {
            html += `<div style="font-size:0.88em;color:#aaa;margin-top:8px;">ä½œæ¥­è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
        }

        return html;
    }

    function buildTimeline(logs) {
        let html = '<div class="tl-container">';
        for (const log of logs) {
            const noteHTML = log.note
                ? `<div class="tl-note">ğŸ“Œ ${esc(log.note)}</div>` : "";

            const extras = [];
            if (log.cell_pot) extras.push(`ğŸ“¦ ${esc(log.cell_pot)}`);
            if (log.quantity) extras.push(`ğŸ”¢ ${esc(log.quantity)}`);
            const extraHTML = extras.length > 0
                ? `<div class="tl-extra">${extras.join(" ï¼ ")}</div>` : "";

            html += `
                <div class="tl-item">
                    <div class="tl-date">${esc(log.work_date)}</div>
                    <span class="tl-type">${esc(log.work_type)}</span>
                    ${extraHTML}
                    <div class="tl-content">${esc(log.content)}</div>
                    ${noteHTML}
                </div>
            `;
        }
        html += '</div>';
        return html;
    }

    /* ============================================================
       ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
       ============================================================ */
    function statusBadge(status) {
        const clsMap = {
            "è¨ˆç”»ä¸­": "badge-plan",
            "çµ‚äº†": "badge-done",
            "è‚²è‹—ä¸­": "badge-active",
            "ã¾ã‚‚ãªãåç©«é–‹å§‹": "badge-active",
            "åç©«ä¸­": "badge-active",
            "ã¾ã‚‚ãªãåç©«çµ‚äº†": "badge-active",
        };
        const cls = clsMap[status] || "";
        return `<span class="badge ${cls}">${esc(status)}</span>`;
    }

    function infoItem(label, value) {
        return `<div class="cycle-info-item"><span class="label">${esc(label)}:</span> ${esc(value)}</div>`;
    }

    function esc(str) {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
    }

    function showError(msg) {
        document.getElementById("cycleList").innerHTML =
            `<div class="message-box error">${msg}</div>`;
    }

    /* ============================================================
       ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
       ============================================================ */
    function toggleCard(cycleId) {
        if (expandedCycleId === cycleId) {
            expandedCycleId = null;
        } else {
            expandedCycleId = cycleId;
        }
        render();
    }

    document.getElementById("statusFilter").addEventListener("change", () => {
        expandedCycleId = null;
        render();
    });

    /* ============================================================
       èµ·å‹•
       ============================================================ */
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("appTitle").textContent = "ğŸŒ¾ " + (CONFIG.TITLE || "è¾²ä½œæ¥­è¨˜éŒ²ç°¿");
        loadData();
    });
    </script>
</body>
</html>
